<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>{{ data.title }}</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>
<script src="https://cdn.tailwindcss.com"></script>
<script>
tailwind.config = {
  theme: {
    extend: {
      colors: {
        bg: '#0f1117',
        surface: '#1a1d27',
        bdr: '#2a2d3a',
        muted: '#8b8fa3',
        accent: '#6c7aee',
        'accent-light': '#8b96f7',
      }
    }
  }
}
</script>
<style>
  /* Tailwind doesn't handle table hover on child elements well, keep this one rule */
  tr:hover td { background: rgba(108, 122, 238, 0.05); }
  tr.report-hidden, tr.search-hidden { display: none; }
</style>
</head>
<body class="bg-bg text-gray-200 font-sans leading-relaxed p-8">

<h1 class="text-3xl font-bold mb-1">{{ data.title }}</h1>
<div class="text-muted text-sm mb-8 flex flex-wrap gap-x-6">
  <span>Generated: {{ data.generated_at.strftime('%Y-%m-%d %H:%M:%S') }}</span>
  <span>Rows: {{ data.total_rows | fmt_number }}</span>
  <span>Files: {{ data.csv_files | join(', ') }}</span>
</div>

<div class="bg-surface border border-bdr rounded-lg px-5 py-4 mb-8 text-sm">
  <strong class="text-accent-light">Detected columns ({{ data.available_columns | length }}):</strong>
  {% for col in data.available_columns %}<code class="bg-bg px-1.5 py-0.5 rounded text-xs mx-0.5">{{ col }}</code>{% endfor %}
</div>

<div id="selectorBar" class="bg-surface border border-bdr rounded-lg px-5 py-4 mb-8 flex flex-wrap gap-6 items-center">
  {% if data.per_tenant_json %}
  <div class="flex items-center gap-2">
    <label class="text-sm text-muted font-medium">Tenant</label>
    <select id="tenantDropdown" class="bg-bg border border-bdr text-gray-200 rounded px-3 py-1.5 text-sm">
      <option value="">All Tenants (Stack)</option>
      {% for t in data.tenant_summaries %}<option value="{{ t.schema_name }}">{{ t.schema_name }}</option>{% endfor %}
    </select>
  </div>
  <div id="reportSelectorWrap" class="hidden flex items-center gap-2">
    <label class="text-sm text-muted font-medium">Report</label>
    <select id="reportDropdown" class="bg-bg border border-bdr text-gray-200 rounded px-3 py-1.5 text-sm">
      <option value="">All Reports (Tenant)</option>
    </select>
  </div>
  {% endif %}
  <div id="reportFilterBadge" class="hidden flex items-center gap-2 bg-bg border border-bdr rounded px-3 py-1.5">
    <span class="text-xs text-muted">Report filter:</span>
    <span id="reportFilterLabel" class="text-xs text-accent-light font-medium max-w-[250px] truncate"></span>
    <button onclick="clearReportFilter()" class="text-muted hover:text-gray-200 text-xs leading-none ml-1" title="Clear filter">&#x2715;</button>
  </div>
  <div class="flex items-center gap-2 {% if data.per_tenant_json %}ml-auto{% endif %}">
    <label class="text-sm text-muted font-medium">Timezone</label>
    <select id="tzSelector" class="bg-bg border border-bdr text-gray-200 rounded px-3 py-1.5 text-sm min-w-[200px]">
      <option value="UTC">UTC (as stored)</option>
    </select>
  </div>
</div>

<div id="viewStack">
{% include '_stack_view.j2' %}
</div>{# end #viewStack #}

<div id="viewTenant" class="hidden"></div>
<div id="viewReport" class="hidden"></div>

<footer class="text-center text-muted text-xs mt-8 pt-4 border-t border-bdr">
  Generated by <strong>splash</strong> v0.1.0
</footer>

<script>
Chart.defaults.color = '#8b8fa3';
Chart.defaults.borderColor = '#2a2d3a';
const PALETTE = ['#6c7aee','#4ade80','#fb923c','#f87171','#facc15','#a78bfa','#38bdf8','#f472b6','#34d399','#818cf8'];

function barChart(id, labels, values, color) {
  const ctx = document.getElementById(id);
  if (!ctx) return null;
  return new Chart(ctx, {
    type: 'bar',
    data: {
      labels: labels,
      datasets: [{
        data: values,
        backgroundColor: color || PALETTE[0],
        borderRadius: 4,
      }]
    },
    options: {
      responsive: true,
      aspectRatio: 3,
      plugins: { legend: { display: false } },
      scales: { y: { beginAtZero: true } }
    }
  });
}

function doughnutChart(id, labels, values) {
  const ctx = document.getElementById(id);
  if (!ctx) return null;
  return new Chart(ctx, {
    type: 'doughnut',
    data: {
      labels: labels,
      datasets: [{
        data: values,
        backgroundColor: PALETTE.slice(0, labels.length),
        borderWidth: 0,
      }]
    },
    options: {
      responsive: true,
      plugins: { legend: { position: 'right', labels: { boxWidth: 12, padding: 8 } } }
    }
  });
}

function lineChart(id, labels, values) {
  const ctx = document.getElementById(id);
  if (!ctx) return null;
  return new Chart(ctx, {
    type: 'line',
    data: {
      labels: labels,
      datasets: [{
        data: values,
        borderColor: PALETTE[3],
        backgroundColor: 'rgba(248,113,113,0.1)',
        fill: true,
        tension: 0.3,
        pointRadius: 2,
      }]
    },
    options: {
      responsive: true,
      aspectRatio: 3,
      plugins: { legend: { display: false } },
      scales: { y: { beginAtZero: true } }
    }
  });
}

function _scatterChart(id, pts) {
  const el = document.getElementById(id);
  if (!el) return null;
  return new Chart(el, {
    type: 'scatter',
    data: {
      datasets: [{
        data: pts.map(p => ({x: p.duration_s, y: p.size})),
        backgroundColor: 'rgba(108,122,238,0.6)',
        pointRadius: 4,
      }]
    },
    options: {
      responsive: true,
      plugins: {
        legend: { display: false },
        tooltip: {
          callbacks: {
            label: function(context) {
              const p = pts[context.dataIndex];
              return p.name + ': ' + p.duration_s + 's, ' + (p.size/1024).toFixed(1) + 'KB';
            }
          }
        }
      },
      aspectRatio: 3,
      scales: {
        x: { title: { display: true, text: 'Duration (s)' } },
        y: { title: { display: true, text: 'File Size (bytes)' } }
      }
    }
  });
}

{# ── Timezone utilities (always present) ── #}
let _currentTZ = 'UTC';
let _currentTenant = null;
let _currentReport = null;

function fmtTime(utcStr) {
  if (!utcStr || !utcStr.includes(' ')) return utcStr || '';
  if (_currentTZ === 'UTC') return utcStr;
  try {
    const d = new Date(utcStr.replace(' ', 'T') + 'Z');
    if (isNaN(d.getTime())) return utcStr;
    const parts = new Intl.DateTimeFormat('en-CA', {
      timeZone: _currentTZ,
      year: 'numeric', month: '2-digit', day: '2-digit',
      hour: '2-digit', minute: '2-digit', second: '2-digit',
      hour12: false,
    }).formatToParts(d);
    const p = {};
    parts.forEach(x => p[x.type] = x.value);
    return `${p.year}-${p.month}-${p.day} ${p.hour}:${p.minute}:${p.second}`;
  } catch(e) { return utcStr; }
}

function convertTimestamps() {
  document.querySelectorAll('[data-utc]').forEach(el => {
    const raw = el.dataset.utc;
    if (raw) el.textContent = fmtTime(raw);
  });
}

{# ── Inventory charts ── #}
{% if data.inventory %}
barChart('topReportsChart',
  {{ data.inventory.top_reports_by_frequency[:15] | map(attribute=0) | list | tojson }},
  {{ data.inventory.top_reports_by_frequency[:15] | map(attribute=1) | list | tojson }},
  PALETTE[0]
);
{% if data.inventory.reports_by_type %}
doughnutChart('reportTypeChart',
  {{ data.inventory.reports_by_type.keys() | list | tojson }},
  {{ data.inventory.reports_by_type.values() | list | tojson }}
);
{% endif %}
{% endif %}

{# ── Timing charts ── #}
{% if data.timing and not data.per_tenant_json %}
barChart('durationChart',
  {{ data.timing.duration_buckets.keys() | list | tojson }},
  {{ data.timing.duration_buckets.values() | list | tojson }},
  PALETTE[5]
);
barChart('hourlyChart',
  {{ data.timing.hourly_distribution.keys() | list | tojson }},
  {{ data.timing.hourly_distribution.values() | list | tojson }},
  PALETTE[6]
);
barChart('weeklyChart',
  {{ data.timing.weekly_distribution.keys() | list | tojson }},
  {{ data.timing.weekly_distribution.values() | list | tojson }},
  PALETTE[1]
);
{% endif %}

{# ── Error charts ── #}
{% if data.errors %}
{% if data.errors.error_code_distribution %}
doughnutChart('errorCodeChart',
  {{ data.errors.error_code_distribution.keys() | list | tojson }},
  {{ data.errors.error_code_distribution.values() | list | tojson }}
);
{% endif %}
{% if data.errors.failures_per_day and not data.per_tenant_json %}
lineChart('failuresPerDayChart',
  {{ data.errors.failures_per_day | map(attribute=0) | list | tojson }},
  {{ data.errors.failures_per_day | map(attribute=1) | list | tojson }}
);
{% endif %}
{% if data.errors.failure_rate_by_report %}
(function() {
  const items = {{ data.errors.failure_rate_by_report | tojson }};
  const top = items.filter(r => r.failures > 0).slice(0, 15);
  barChart('failureRateByReportChart',
    top.map(r => r.name),
    top.map(r => r.rate),
    PALETTE[3]
  );
})();
{% endif %}
barChart('failuresByHourChart',
  {{ data.errors.failures_by_hour.keys() | list | tojson }},
  {{ data.errors.failures_by_hour.values() | list | tojson }},
  PALETTE[3]
);
{% if data.errors.failures_by_engine %}
(function() {
  const engines = {{ data.errors.failures_by_engine | tojson }};
  const labels = Object.keys(engines);
  barChart('failuresByEngineChart',
    labels,
    labels.map(k => engines[k].rate),
    PALETTE[2]
  );
  barChart('failureCountByEngineChart',
    labels,
    labels.map(k => engines[k].failures),
    PALETTE[3]
  );
})();
{% endif %}
{% endif %}

{# ── Engine charts ── #}
{% if data.engine %}
{% if data.engine.load_per_engine and not data.per_tenant_json %}
barChart('engineLoadChart',
  {{ data.engine.load_per_engine.keys() | list | tojson }},
  {{ data.engine.load_per_engine.values() | list | tojson }},
  PALETTE[2]
);
{% endif %}
{% if data.engine.load_per_node %}
barChart('nodeLoadChart',
  {{ data.engine.load_per_node.keys() | list | tojson }},
  {{ data.engine.load_per_node.values() | list | tojson }},
  PALETTE[7]
);
{% endif %}
{% endif %}

{# ── Performance scatter ── #}
{% if data.performance and data.performance.duration_vs_size %}
_scatterChart('scatterChart', {{ data.performance.duration_vs_size | tojson }});
{% endif %}

{# ── Multi-tenant drill-down ── #}
{% if data.per_tenant_json %}
const TENANT_DATA = {{ data.per_tenant_json | tojson }};
let _activeCharts = [];
function _track(c) { if (c) _activeCharts.push(c); }
function _destroyCharts() { _activeCharts.forEach(c => c.destroy()); _activeCharts = []; }

function esc(s) {
  return String(s == null ? '' : s)
    .replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
}
function fmtNumber(v) {
  if (v == null) return '';
  return Number(v).toLocaleString('en');
}
function fmtBytes(v) {
  if (v == null) return '';
  let x = parseFloat(v);
  for (const u of ['B','KB','MB','GB']) {
    if (Math.abs(x) < 1024) return x.toFixed(1) + ' ' + u;
    x /= 1024;
  }
  return x.toFixed(1) + ' TB';
}
function fmtDuration(s) {
  if (s == null) return '';
  if (s < 1) return Math.round(s * 1000) + 'ms';
  if (s < 60) return s.toFixed(1) + 's';
  const m = s / 60;
  if (m < 60) return m.toFixed(1) + 'm';
  return (m / 60).toFixed(1) + 'h';
}
function fmtPct(v) { return v == null ? '' : v.toFixed(1) + '%'; }

{% include '_js_tenant_view.j2' %}
{% include '_js_report_view.j2' %}

document.getElementById('tenantDropdown').addEventListener('change', e => {
  e.target.value ? showTenantView(e.target.value) : showStackView();
});
document.getElementById('reportDropdown').addEventListener('change', e => {
  const t = document.getElementById('tenantDropdown').value;
  e.target.value ? showReportView(t, e.target.value) : showTenantView(t);
});

barChart('tenantExecChart',
  {{ data.tenant_summaries | map(attribute='schema_name') | list | tojson }},
  {{ data.tenant_summaries | map(attribute='total_executions') | list | tojson }},
  PALETTE[0]
);

{# ── Tenant color map ── #}
const TENANT_COLORS = {};
Object.keys(TENANT_DATA).forEach(function(t, i) {
  TENANT_COLORS[t] = PALETTE[i % PALETTE.length];
});

{# ── Style tenant pills with their assigned colors ── #}
document.querySelectorAll('.stack-tenant-pill').forEach(function(pill) {
  const color = TENANT_COLORS[pill.dataset.tenant];
  if (color) {
    pill.style.borderColor = color;
    pill.style.color = color;
    pill.style.backgroundColor = color + '22';
  }
});

{# ── Stacked chart infrastructure ── #}
let _activeTenants = new Set(Object.keys(TENANT_DATA));
let _stackedChartInstances = [];

function _destroyStackedCharts() {
  _stackedChartInstances.forEach(function(c) { if (c) c.destroy(); });
  _stackedChartInstances = [];
}
function _trackStacked(c) { if (c) _stackedChartInstances.push(c); return c; }

function stackedBarChart(id, labels, tenantDatasets, onClickCb) {
  const ctx = document.getElementById(id);
  if (!ctx) return null;
  const tenantOrder = tenantDatasets.map(function(d) { return d[0]; });
  return new Chart(ctx, {
    type: 'bar',
    data: {
      labels: labels,
      datasets: tenantDatasets.map(function(d) {
        return { label: d[0], data: d[1], backgroundColor: TENANT_COLORS[d[0]], borderRadius: 2 };
      })
    },
    options: {
      responsive: true,
      aspectRatio: 3,
      plugins: {
        legend: { display: false },
        tooltip: { mode: 'index', intersect: false }
      },
      scales: { x: { stacked: true }, y: { stacked: true, beginAtZero: true } },
      onClick: function(evt, elements) {
        if (!elements.length || !onClickCb) return;
        const tenant = tenantOrder[elements[0].datasetIndex];
        if (tenant) {
          document.getElementById('tenantDropdown').value = tenant;
          onClickCb(tenant);
        }
      }
    }
  });
}

function _initStackedCharts() {
  const tenants = Object.keys(TENANT_DATA).filter(function(t) { return _activeTenants.has(t); });
  if (!tenants.length) return;

  {# Duration distribution #}
  const buckets = ['<1s','1-10s','10s-1m','1-5m','5-30m','30m+'];
  _trackStacked(stackedBarChart('durationChart', buckets,
    tenants.map(function(t) {
      const db = TENANT_DATA[t].duration_buckets || {};
      return [t, buckets.map(function(b) { return db[b] || 0; })];
    }), showTenantView));

  {# Hourly distribution #}
  const hours = [0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23];
  _trackStacked(stackedBarChart('hourlyChart', hours,
    tenants.map(function(t) {
      const hd = TENANT_DATA[t].hourly_distribution || {};
      return [t, hours.map(function(h) { return hd[h] || hd[String(h)] || 0; })];
    }), showTenantView));

  {# Weekly distribution #}
  const days = ['Monday','Tuesday','Wednesday','Thursday','Friday','Saturday','Sunday'];
  _trackStacked(stackedBarChart('weeklyChart', days,
    tenants.map(function(t) {
      const wd = TENANT_DATA[t].weekly_distribution || {};
      return [t, days.map(function(d) { return wd[d] || 0; })];
    }), showTenantView));

  {# Failures per day #}
  const allDatesSet = new Set();
  tenants.forEach(function(t) {
    (TENANT_DATA[t].failures_per_day || []).forEach(function(p) { allDatesSet.add(p[0]); });
  });
  const sortedDates = Array.from(allDatesSet).sort();
  if (sortedDates.length) {
    _trackStacked(stackedBarChart('failuresPerDayChart', sortedDates,
      tenants.map(function(t) {
        const m = {};
        (TENANT_DATA[t].failures_per_day || []).forEach(function(p) { m[p[0]] = p[1]; });
        return [t, sortedDates.map(function(d) { return m[d] || 0; })];
      }), showTenantView));
  }

  {# Engine load #}
  const allEnginesSet = new Set();
  tenants.forEach(function(t) {
    Object.keys(TENANT_DATA[t].load_per_engine || {}).forEach(function(e) { allEnginesSet.add(e); });
  });
  const engineLabels = Array.from(allEnginesSet);
  if (engineLabels.length) {
    _trackStacked(stackedBarChart('engineLoadChart', engineLabels,
      tenants.map(function(t) {
        const lpe = TENANT_DATA[t].load_per_engine || {};
        return [t, engineLabels.map(function(e) { return lpe[e] || 0; })];
      }), showTenantView));
  }
}

function toggleTenant(name) {
  if (_activeTenants.has(name)) {
    if (_activeTenants.size === 1) return;
    _activeTenants.delete(name);
  } else {
    _activeTenants.add(name);
  }
  const pill = document.querySelector('.stack-tenant-pill[data-tenant="' + CSS.escape(name) + '"]');
  if (pill) pill.style.opacity = _activeTenants.has(name) ? '1' : '0.35';
  _destroyStackedCharts();
  _initStackedCharts();
}

_initStackedCharts();
{% endif %}

{# ── Timezone selector init (always present) ── #}
(function() {
  const sel = document.getElementById('tzSelector');
  const localTZ = Intl.DateTimeFormat().resolvedOptions().timeZone;
  if (localTZ !== 'UTC') {
    sel.appendChild(new Option('Local (' + localTZ + ')', localTZ));
  }
  ['America/New_York','America/Chicago','America/Denver','America/Los_Angeles','America/Phoenix',
   'Europe/London','Europe/Paris','Asia/Tokyo','Australia/Sydney']
    .filter(tz => tz !== localTZ)
    .forEach(tz => sel.appendChild(new Option(tz, tz)));
  convertTimestamps();
})();

{# ── Report cross-filter ── #}
function setReportFilter(name) {
  document.getElementById('reportFilterLabel').textContent = name;
  document.getElementById('reportFilterBadge').classList.remove('hidden');
  const searchEl = document.getElementById('inventorySearch');
  if (searchEl) searchEl.value = '';
  document.querySelectorAll('tr[data-report]').forEach(function(row) {
    row.classList.toggle('report-hidden', row.dataset.report !== name);
    row.classList.remove('search-hidden');
  });
}

function clearReportFilter() {
  document.getElementById('reportFilterBadge').classList.add('hidden');
  document.querySelectorAll('tr[data-report]').forEach(function(row) {
    row.classList.remove('report-hidden');
  });
}

function applyInventorySearch(q) {
  const lower = q.toLowerCase();
  document.querySelectorAll('#inventoryTable tr[data-report]').forEach(function(row) {
    row.classList.toggle('search-hidden', !row.dataset.report.toLowerCase().includes(lower));
  });
}

document.getElementById('tzSelector').addEventListener('change', e => {
  _currentTZ = e.target.value;
  convertTimestamps();
  if (_currentReport && typeof showReportView === 'function') {
    showReportView(_currentTenant, _currentReport);
  } else if (_currentTenant && typeof showTenantView === 'function') {
    showTenantView(_currentTenant);
  }
});
</script>
</body>
</html>
